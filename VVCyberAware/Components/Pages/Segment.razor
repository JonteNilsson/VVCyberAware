@page "/segment/{id:int}"
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using VVCyberAware.Components.CustomComponents
@using VVCyberAware.Data
@using VVCyberAware.Shared.Models.ApiModels
@using VVCyberAware.Shared.Models.DbModels
@using VVCyberAware.Shared.Models.Services.CategoryService
@using VVCyberAware.Shared.Models.Services.QuestionService
@using VVCyberAware.Shared.Models.Services.SegmentService
@using VVCyberAware.Shared.Models.Services.SubCategoryService
@inject ICategoryService categoryService
@inject ISegmentService segmentService
@inject IQuestionService questionService;
@inject ISubCService subCService;
@rendermode InteractiveServer

@inject UserManager<ApplicationUser> UserManager
@inject IHttpContextAccessor HttpContextAccessor


@if (segment == null)
{
    <h1>Segment not found!</h1>
}
else
{
    <div class="main-container">
@*         <h1 class="text-center">@(segment.Category.Name == null ? "Ingen Kategori" : segment.Category.Name)</h1> *@
        @if(categories != null){
            <h1 class="text-center">@categories.First(c => c.Id == segment.CategoryId).Name</h1>
        }
        else
        {
            <h1 class="text-center">Unknown</h1>
        }
        <div class="segment-container">
	    <h1>@segment.Name</h1>

        @if(subCategories != null)
        {
            @foreach(var sub in subCategories.Where(s=>s.SegmentId == segment.Id))
            {
                <h3>@sub.Description</h3>
                @if (questions != null)
                {
                    @foreach (var question in questions.FindAll(q => q.SubCategoryId == sub.Id).ToList())
                    {
                        <div class="question-box">
                            <form>
                                <p class="font-weight-bold">@question.QuestionText</p>

                                @for (int i = 0; i < question.Answers.Count(); i++)
                                {
                                    var answer = question.Answers.ElementAt(i);

                                    <div class="form-check">
                                        <input 
                                            class="form-check-input" type="radio" 
                                            id="@($"QuestionRadio_{question.Id}_{i}")" 
                                            name="@($"QuestionRadio_{question.Id}")" 
                                            value="@answer.Key">
                                        <label class="form-check-label" for="@($"QuestionRadio_{question.Id}_{i}")">@answer.Key</label>
                                    </div>
                                }
                            </form>
                        </div>
                    }
                }
            }
        }
        <button class="btn btn-primary" @onclick="Submit">Submit</button>
          
      </div>
      <div class="d-flex justify-content-center mb-5 ">
      <a href="/home" class="btn btn-danger" >Back</a>
      </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private List<CategoryApiModel>? categories;
    private SegmentApiModel? segment;
    private List<SubCategoryApiModel>? subCategories;
    private List<QuestionApiModel>? questions;
    private Dictionary<int, string> selectedAnswers = new Dictionary<int, string>();

    private void Submit()
    {
        
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        categories = await categoryService.GetAllCategoriesAsync();
        segment = await segmentService.GetSegmentByIdAsync(Id);
        subCategories = await subCService.GetSubCategoriesAsync();
        questions = await questionService.GetQuestionsAsync();

    }
}


